# MonkeySpeak

**MonkeySpeak** — это P2P приложение для голосовой связи, работающее без центрального сервера для передачи аудио. Все звонки происходят напрямую между участниками.

## Основные возможности

- **P2P голосовая связь** — прямое соединение между участниками без задержек
- **Минимальная нагрузка на сервер** — сервер используется только для координации соединения
- **Качественное аудио** — кодирование Opus с битрейтом 32 kbps
- **Простой интерфейс** — создание комнаты или подключение по коду

## Технологии

- **.NET 9.0** — основной фреймворк
- **Raylib-cs** — графический интерфейс
- **SoundFlow** — захват и воспроизведение аудио
- **Concentus (Opus)** — аудио кодек для сжатия голоса
- **WebSocket** — сигнализация между клиентами
- **UDP** — передача аудио данных

## Engine

Проект использует собственную реализацию игрового движка на базе **Raylib-cs**. Engine включает систему сцен, менеджеры ресурсов, анимацию и UI компоненты, что позволяет создавать интерактивный интерфейс приложения.

## Серверная часть

Для работы приложения необходим сервер, который выполняет функции **сигналинга** (обмен информацией о соединении через WebSocket) и **STUN-сервера** (определение публичного IP-адреса).

Серверная часть открыто распространяется в репозитории: [monkeyspeak.backend](https://github.com/sanchela228/monkeyspeak.backend)

Вы можете легко развернуть сервер локально или в своей сети для полностью автономной работы системы.

## Как работает связь

### 1. Инициализация соединения

Пользователь может создать сессию или подключиться к существующей по коду:

```
[Пользователь] → [CreateSession/ConnectToSession] → [WebSocket сервер]
```

### 2. Получение публичного IP

Приложение использует STUN-сервер для определения публичного IP-адреса:

```
[UDP клиент] → [STUN сервер] → [Публичный IP:Port]
```

- В DEBUG режиме используется локальный LAN адрес
- В RELEASE режиме получается публичный IP через STUN

### 3. Обмен информацией через сигнализацию

WebSocket сервер передает информацию о IP-адресах между участниками:

```
[Клиент A] ← [WebSocket: HolePunching] → [Клиент B]
            IP A ←----------→ IP B
```

### 4. UDP Hole Punching

Устанавливается прямое UDP соединение между участниками:

```
[Клиент A UDP] ←--PING/PONG--→ [Клиент B UDP]
```

- Отправка PING пакетов для пробития NAT
- Получение PONG подтверждает установку соединения
- После успешного пробития состояние меняется на `Connected`

### 5. Передача аудио

После установки соединения начинается обмен аудио данными:

```
[Микрофон] → [Захват PCM] → [Opus кодирование] → [UDP пакет] 
                                                      ↓
[Динамик] ← [Воспроизведение] ← [Opus декодирование] ← [UDP прием]
```

**Параметры аудио:**
- Частота дискретизации: 48 кHz (Broadcast качество)
- Каналы: стерео
- Длительность фрейма: 20 ms
- Битрейт: 32 kbps
- Тип сигнала: OPUS_SIGNAL_VOICE

### 6. Управление соединением

Через UDP передаются не только аудио данные, но и управляющие команды:

- **MessageType.Audio** — аудио данные
- **MessageType.Control** — управляющие команды (мут, размут, отбой)
- **MessageType.HolePunch** — служебные сообщения для поддержания соединения

## Структура проекта

```
MonkeySpeak/
├── App/
│   ├── Scenes/              # UI сцены (StartUp, Room, Creator, Invited)
│   ├── System/
│   │   ├── Calls/           # Логика звонков
│   │   │   ├── Application/ # P2PCallManager, CallFacade
│   │   │   ├── Media/       # AudioTranslator (обработка аудио)
│   │   │   └── Infrastructure/ # WebSocket, STUN клиенты
│   │   ├── Managers/        # UdpUnifiedManager
│   │   └── Modules/         # WebSocketClient, Network
│   └── Context.cs           # Глобальный контекст приложения
└── Program.cs               # Точка входа
```

## Запуск

1. Убедитесь, что установлен **.NET 9.0 SDK**
2. Настройте `NetworkConfig.xml` с адресом вашего сервера:
   ```xml
   <Domain>your-server.com</Domain>
   <Port>8080</Port>
   ```
3. Соберите и запустите проект:
   ```bash
   dotnet run
   ```

## Безопасность

- Приватные ключи устройства хранятся в `SecureStorage`
- Каждая сессия имеет уникальный токен
- P2P соединение минимизирует передачу данных через сервер
